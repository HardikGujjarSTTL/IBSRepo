@model IBS.Models.CallMarkedOnlineModel
@{    
    ViewData["Title"] = "Call Marked Manage";    
}
<div class="list-inner">
    <div class="tast-list">
        <h2><label id="lblTitle" style="font-weight:600;font-family:'Poppins', sans-serif;font-size:24px;">ONLINE CALL MARKING FORM</label></h2>
    </div>
    <div>
        <a asp-action="Index" asp-controller="CallMarkedOnline" class="formBtn viewall-btn" id="viewList">View List</a>
    </div>
</div>
@*<div class="row">*@
<form asp-action="Manage" asp-controller="" id="frmCallMarked">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="accordion-body" id="body">
        <div class="row my-0">
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Case No :</label>
                <label id="lblCaseNo" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="CASE_NO" />
            </div>
            <div class="col-md-4 mb-3">
                <label for="Reference" style="padding-right:10px;">Call Date - SNO :</label>
                <label>
                    <span id="lblCallDate" style="text-transform: uppercase; color:red;"></span>
                    <span id="lblRegTime" style="text-transform: uppercase; color:red;"></span> -
                    <span id="lblSNo" style="text-transform: uppercase; color:red;"></span>
                </label>
                <input type="hidden" asp-for="CALL_RECV_DT" />
                <input type="hidden" asp-for="REG_TIME" />
                <input type="hidden" asp-for="CALL_SNO" />
            </div>
            <div class="col-md-5 mb-3">
                <label for="Reference" style="padding-right:10px;">Contract No :</label>
                <label id="lblContractNo" style="text-transform: uppercase; color:red;"></label>
                <label id="lblL5noPo" style="text-transform: uppercase; color:red;"></label>
                <label id="lblRly" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="PO_NO" />
                <input type="hidden" asp-for="L5NO_PO" />
                <input type="hidden" asp-for="RLY" />
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-3 mb-3">
                <label for="" style="padding-right:36px;">Date :</label>
                <label id="lblDate" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="PO_DT" />
                <input type="hidden" asp-for="LETTER_DT" />
            </div>
            <div class="col-md-9 mb-3">
                <label for="Reference" style="padding-right:71px;">Vendor :</label>
                <label id="lblVendor" style="text-transform: uppercase; color:red;"></label>
                <input type="text" id="txtCALLLETTERDT" style="width:102px;display:none;" />
                <input type="hidden" asp-for="VEND_NAME" />
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-12 mb-3">
                <label for="Reference" style="padding-right: 20px;">Manufacturer/Place of Inspection : </label>
                <label id="lblMFG" style="text-transform: uppercase; color:red;"></label>
                <label id="lblManuf" style="text-transform: uppercase;display:none;"></label>
                <input type="hidden" asp-for="MFG" />
                <input type="hidden" asp-for="MFG_CD" />
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-6 mb-3">
                <div class="reference">
                    <label for="Reference">Remarks</label>
                    <textarea asp-for="REMARKS" rows="1"> </textarea>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="reference">
                    <label for="Reference">Inspecting Er.</label>
                    @Html.DropDownListFor(Model => Model.IE_NAME, new SelectList(@ViewBag.ClusterIEList , "Value", "Text"),"--Select--")
                </div>
            </div>
        </div>
        <div class="row my-0">
            <div class="row my-0">
                <div class="col-md-12 mb-3">
                    <label for="Reference">Item</label>
                    <label id="lblItem" style="text-transform: uppercase; color:red;"></label>
                    <input type="hidden" asp-for="ITEM_DESC_PO" />
                </div>
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Staggered DP :</label>
                <label id="lblStaggered" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="STAGG_DP" />
            </div>
            <div class="col-md-4 mb-3">
                <label for="Reference" style="padding-right:10px;">1. Lot Size & DP :</label>
                <label id="lblLotSize1" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="LOT_DP_1" />
            </div>
            <div class="col-md-5 mb-3">
                <label for="Reference" style="padding-right:10px;">2. Lot Size & DP :</label>
                <label id="lblLotSize2" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="LOT_DP_2" />
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Quantity Ordered :</label>
                <label id="lblQtyOrder" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="QTY_ORDERED" />
            </div>
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Quantity Offered :</label>
                <label id="lblQtyOffer" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="QTY_TO_INSP" />
            </div>
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Call Material Value :</label>
                <label id="lblCallMaterialValue" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="CALL_MATERIAL_VALUE" />
            </div>
            <div class="col-md-3 mb-3">
                <label for="Reference" style="padding-right:10px;">Desire Date :</label>
                <label id="lblDesireDate" style="text-transform: uppercase; color:red;"></label>
                <input type="hidden" asp-for="INSP_DESIRE_DATE" />
            </div>
        </div>
        <div class="row my-0">
            <div class="col-md-5 mb-3">
                <div class="reference">
                    <label for="Reference">Item to be inspected viz. Mechanical, Electrical, Civil etc</label>
                    @Html.DropDownListFor(Model => Model.DEPT_DROPDOWN, new SelectList(@ViewBag.InspectedList , "Value", "Text"),"--Select--")
                    <label id="lblDept_CD" style="display:none;"></label> <input type="hidden" asp-for="DEPARTMENT_CODE" />
                    <label id="lblDepartment" style="display:none;"></label> <input type="hidden" asp-for="DEPARTMENT" />
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label for="Reference" style="padding-right:10px;">Final Or Stage Inspection</label>
                <label id="lblFinalStageInspection" style="text-transform: uppercase; color:red;">test</label>
                <input type="hidden" asp-for="FINAL_OR_STAGE" />
            </div>
        </div>
        @if (Model.PREV_CALL_1 != null || Model.PREV_CALL_2 != null)
        {
            <div class="alert alert-warning center" style="text-align:center;">
                <h4>PREVIOUS CALL DETAILS</h4>
            </div>
            <div class="row my-0">
                <div class="col-md-12 mb-3">
                    <div id="lblCall1" style="text-transform: uppercase; color:red;"></div>
                    <div id="lblCall2" style="text-transform: uppercase; color:red;"></div>
                </div>
            </div>
        }
        <div class="row my-0">
            <div class="col-md-12 mb-3">
                <div class="savenext-btn">
                    <button type="button" class="save-btn active Permission_Save" id="btnSave">Save</button>
                    @*<button type="button" class="reset-btn" id="btnCancel">Cancel</button>*@
                    <button type="button" class="reset-btn" id="btnCaseHistory">Case History</button>
                    <button type="button" class="reset-btn" id="btnRejectCall">Reject Call</button>
                    <button type="button" class="reset-btn" id="btnSendMail" style="display:none;">Send Email For Incomplete Calls</button>
                </div>
            </div>
        </div>
        <section id="rejectCall" style="display:none;">
            <div class="row my-0">
                <div class="col-md-12 mb-3">
                    <div class="reference">
                        <label for="Reference">Reason of rejection</label>
                        <input type="text" class="input" asp-for="REJECT_REASON"> </input>
                        @*<span asp-validation-for="REJECT_REASON" class="text-danger"></span>*@
                    </div>
                </div>
            </div>
            <div class="col-md-12 mb-3">
                <div class="savenext-btn">
                    <button type="button" class="save-btn active" id="btnSaveReject">Send Email For Rejected Calls</button>
                </div>
            </div>
        </section>
    </div>
</form>
@*</div>*@

<script>
    $(document).ready(function () {
        $("#viewList").css("display", "block");
        $("#btnSave").click(function () {
            SaveCallMarkedDetail();
        });

        $("#DEPT_DROPDOWN").change(function () {
            FillClusterIE();
        });

        $("#btnRejectCall").click(function () {
            $("#rejectCall").css("display", "block");
        });

        $("#btnCaseHistory").click(function () {
            //window.location.href = "@Url.Action("CaseHistory","CallMarkedOnline")" + "?CASE_NO=" + $("#lblCaseNo").html();
            window.open("@Url.Action("CaseHistory","CallMarkedOnline")" + "?CASE_NO=" + $("#lblCaseNo").html(), "_blank");
        });

        //$("#btnCancel").click(function () {
        //    window.location.href = "@Url.Action("Index","CallMarkedOnline")";
        //});
        $("#btnSaveReject").click(function () {
            RejectCall();
        });

        $("#btnSendMail").click(function () {
            IncompleteCall()
        })

        $("#lblContractNo").html("@Model.PO_NO");
        $("#lblDate").html("@Model.PO_DT");
        $("#lblVendor").html("@Model.VEND_NAME");
        if ("@Model.VEND_REMARKS" != "") {
            $("#lblVendor").html("<br><font color='crimson'> Remarks: @Model.VEND_REMARKS");
        }
        $("#lblCaseNo").html("@Model.CASE_NO");
        $("#lblCallDate").html("@Model.CALL_RECV_DT");
        $("#REMARKS").val("@Model.REMARKS");
        $("#lblRegTime").html("(@Model.REG_TIME)");
        $("#lblSNo").html("@Model.CALL_SNO");
        $("#lblQtyOrder").html("@Model.QTY_ORDERED");
        $("#lblQtyOffer").html("@Model.QTY_TO_INSP");
        $("#lblItem").html("@Model.ITEM_DESC_PO");
        $("#lblMFG").html("@Model.MFG");
        if ("@Model.MFG_REMARKS" != "") {
            $("#lblMFG").html("<br><font color='crimson'> Remarks: @Model.MFG_REMARKS");
        }
        $("#lblRly").html("@Model.RLY");
        $("#lblL5noPo").html("@Model.L5NO_PO");
        $("#lblManuf").html("@Model.MFG_CD");
        $("#txtCALLLETTERDT").val("@Model.LETTER_DT");
        $("#lblStaggered").html("@Model.STAGG_DP");
        $("#lblLotSize1").html("@Model.LOT_DP_1");
        $("#lblLotSize2").html("@Model.LOT_DP_2");
        $("#lblCallMaterialValue").html("@Model.CALL_MATERIAL_VALUE");
        $("#lblDesireDate").html("@Model.INSP_DESIRE_DATE");
        $("#DEPT_DROPDOWN").val("@Model.DEPARTMENT_CODE");
        $("#lblDept_CD").html("@Model.DEPARTMENT_CODE");
        $("#lblDepartment").html("@Model.DEPARTMENT");
        $("#lblFinalStageInspection").html("@Model.FINAL_OR_STAGE");

        $("#lblCall1").html("@Model.PREV_CALL_1");
        $("#lblCall2").html("@Model.PREV_CALL_2");

        if ($("#lblItem").html() == "" || $("#lblQtyOffer").html() == "" || $("#lblQtyOffer").html() == "0") {
            $("#btnSendMail").css("display", "block");
        }
        else {
            $("#btnSendMail").css("display", "none");
        }
    });

    function SaveCallMarkedDetail() {
        var formData = new FormData($("#frmCallMarked")[0]);
        $.ajax({
            url: '@Url.Action("Call_Marked_Online_Save", "CallMarkedOnline")',
            type: "POST",
            dataType: "JSON",
            data: formData,
            processData: false, // Prevent jQuery from converting the data to a string
            contentType: false,
            success: function (response) {
                debugger
                if (response) {
                    ShowHideMsgNew(response, "Successful");
                } else {
                    ShowHideMsgNew(response, "Oops Somthing Went Wrong !!");
                }
                console.log("success");
            }
        });
    }

    function RejectCall() {
        var formData = new FormData($("#frmCallMarked")[0]);
        $.ajax({
            url: '@Url.Action("SendVendorMailForRejectedCall", "CallMarkedOnline")',
            type: "POST",
            dataType: "JSON",
            data: formData,
            processData: false, // Prevent jQuery from converting the data to a string
            contentType: false,
            success: function (response) {
                debugger
                if (response) {
                    ShowHideMsgNew(response, "This Call Has Been Deleted!!!");
                    setTimeout(function () {
                        window.location.href = "@Url.Action("Index", "CallMarkedOnline")";
                    }, 1000);
                } else {
                    ShowHideMsgNew(response, "Oops Somthing Went Wrong !!");
                }
            }
        });
    }

    function IncompleteCall() {
        var formData = new FormData($("#frmCallMarked")[0]);
        $.ajax({
            url: '@Url.Action("SendVendorEmailForIncompleteCall", "CallMarkedOnline")',
            type: "POST",
            dataType: "JSON",
            data: formData,
            processData: false, // Prevent jQuery from converting the data to a string
            contentType: false,
            success: function (response) {
                debugger
                if (response == 1) {
                    ShowHideMsgNew(true, "This Call Has Been Deleted!!!");
                    setTimeout(function () {
                        window.location.href = "@Url.Action("Index", "CallMarkedOnline")";
                    }, 1000);
                }
                else if (response == 2) {
                    ShowHideMsgNew(false, "This Call cannot be Deleted,Whether Item is their in the Call or The Call is Marked to IE or The Call Status is Other then Pending!!!");
                }
                else {
                    ShowHideMsgNew(false, "Oops Somthing Went Wrong !!");
                }
            }
        });
    }

    function FillClusterIE() {
        debugger
        var dept = $("#DEPT_DROPDOWN").val();
        $.ajax({
            url: '@Url.Action("BindClusterIE", "CallMarkedOnline")',
            type: "GET",
            dataType: "JSON",
            data: { DeptName: dept },
            success: function (contacts) {
                $("#IE_NAME").html(""); // clear before appending new list
                $("#IE_NAME").append($('<option></option>').val(0).html("--Select--"));
                if (contacts && contacts.length > 0) {
                    $.each(contacts, function (i, cnt) {
                        $("#IE_NAME").append($('<option></option>').val(cnt.Value).html(cnt.Text));
                    });
                    //if (MfgCd1 > 0) {
                    //    $.each(contacts, function (i, cnt) {
                    //        $("#IE_NAME").append($('<option></option>').val(cnt.Value).html(cnt.Text));
                    //    });
                    //    $("#IE_NAME").val(MfgCd1);
                    //} else {
                    //    $.each(contacts, function (i, cnt) {
                    //        $("#IE_NAME").append($('<option></option>').val(cnt.Value).html(cnt.Text));
                    //    });
                    //}
                }
            }
        });
    }
</script>

