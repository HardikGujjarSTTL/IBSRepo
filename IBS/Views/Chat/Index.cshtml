@model IBS.Models.ChatMessage

@{
    ViewData["Title"] = "Index";
    string SenderId = ViewBag.SenderId <= 0 ? "" : Convert.ToString(ViewBag.SenderId);
    string ReceiverId = Model.msg_recv_ID == "0" ? "" : Convert.ToString(Model.msg_recv_ID);
    string SiteUrl = Model.HostUrl;
}

<div class="list-inner">
    <div class="tast-list">
        <h2>Users Chat</h2>
    </div>
</div>
<div class="task-listinput">
    <form role="form" id="frmChatMessage">
        <div class="accordion-body chatArea">
            <div class="chatTopFilter">
                <div class="row my-0">
                    <div class="col-md-3">
                        <label for="Reference">Users</label>
                        <div class="userMultiSelect">@Html.ListBox("dpUser", new MultiSelectList(Common.GetUserMaster(), "Value", "Text"), new { multiple = "multiple" })</div>
                    </div>
                    <div class="col-md-7">
                        <label for="Reference">Message</label>
                        <input type="text" id="txtMessage" />
                    </div>
                    <div class="col-md-2 d-flex justify-content-between">                        
                        <div class="topUploadCustom">
                    <div class="upload-btn-wrapper submitChatBtn">
                        <button><span class="fa fa-paperclip"></span></button>
                        <input type="file" id="fileupload" class="fileUploadNormal" multiple>
                    </div>
                        </div>

                        <div class="savenext-btn" style="margin-top:28px;">
                        <button type="button" class="save-btn active" id="btnSave" onclick="SendMessage(1);"><span class="fa fa-paper-plane"></span></button>
                    </div>
                    </div>
                    
                </div>
            </div>
            <div id="divFile"></div>
            <div class="chatBox">
                <div class="chatBoxHeader">
                    <h2>Message</h2>
                </div>
                <div class="messageBody">
                    <div class="chatBoxBody chatLeftBoxBody">
                    </div>
                    <div class="userChatBox">
                        <div class="chatBoxBody chatRightBoxBody">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<link href="~/css/chat.css" rel="stylesheet" />
<script src="~/js/signalr.min.js"></script>

<link href="~/lib/bootstrap-multiselect/css/bootstrap-multiselect.css" rel="stylesheet" />
<script src="~/lib/bootstrap-multiselect/js/bootstrap-multiselect.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.11/signalr.min.js"></script>

<script type="text/javascript">

    var connection = new signalR.HubConnectionBuilder().withUrl('@SiteUrl' + "/chatHub").build();
    var SenderId = "@SenderId";
    var ReceiverId = "@ReceiverId";
    //var currDate = @DateTime.Now.ToString("dd MMMM yyyy");
    var Cnt = 0;
    var GFileName = "";
    var byteArray = [];


    $(document).ready(function () {
        GetUserReceiverList();
        GetChatMessageList(ReceiverId);

        $('#dpUser').multiselect({
            includeSelectAllOption: true,
        });

        $('#fileupload').change(function (e) {
            var fileInput = this;
            var file = fileInput.files[0];
            debugger
            //var path = "@System.IO.Path.GetFullPath("'+file.name+'")";
            //console.log(path);

            uploadFile3();



            //var formData = new FormData();
            //formData.append("SenderId", "1");
            //formData.append("ReceiverId", "12");
            //formData.append("message", "Test");
            //formData.append("MsgType", "1");

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            //connection.invoke("SendFile", formData);

            //$.ajax({
            //    url: '@Url.Action("UploadFile", "Chat")',
            //    type: 'POST',
            //    data: formData,//{ SingleFile: fileInput.files[0] },
            //    cache: false,
            //    processData: false,
            //    contentType: false
            //}).done(function (response) {
            //    if (response != null) {
            //        console.log(response.filename);
            //        GFileName = response.filename;
            //        //$(".chatLeftBoxBody").html("");
            //        //$(".chatLeftBoxBody").html(response);
            //        //$(".userList").removeClass("active");
            //        //$("#li" + ReceiverId).addClass("active");
            //    }
            //});
        });

        $(document).ajaxSend(function () {
            $(".overlayLoader").hide();
        });
    });

    function GetUserReceiverList() {
        $.ajax({
            url: '@Url.Action("ChatUserReceiver", "Chat")',
            type: 'POST',
            cache: false,
            processData: false,
            contentType: false
        }).done(function (response) {
            if (response != null) {
                $(".chatLeftBoxBody").html("");
                $(".chatLeftBoxBody").html(response);
                $(".userList").removeClass("active");
                $("#li" + ReceiverId).addClass("active");
            }
        });
    }

    function GetChatMessageList(recvid) {
        ReceiverId = recvid;
        $.ajax({
            url: '@Url.Action("ChatMessageHistory", "Chat")/' + ReceiverId,
            type: 'POST',
            cache: false,
            processData: false,
            contentType: false
        }).done(function (response) {
            if (response != null) {
                $(".chatRightBoxBody").html("");
                $(".chatRightBoxBody").html(response);
                $(".userList").removeClass("active");
                $("#li" + ReceiverId).addClass("active");
                $('.chatBoxBody').scrollTop($('.chatBoxBody').height());

                Cnt = parseInt($("#hdnCurrDtCount").val());
            }
        });
    }

    function SendMessage(type) {
        //uploadFile3();
        //uploadFiles()
        var uint8Array = new Uint8Array(byteArray[0]);
        byteArray = Array.from(uint8Array);

        //// Creating textDecoder instance
        //let decoder = new TextDecoder("utf-8");

        //// Using decode method to get string output
        //let str = decoder.decode(byteArray);

        //// Display the output
        //console.log(str);

        debugger
        //byteArray = new Uint8Array([65, 66, 67]);
        var byteString = String.fromCharCode.apply(String, byteArray)
        connection.invoke("UploadFiles", byteString); //UploadFiles

        return;
        const fileInput = document.getElementById("fileupload").files;

        var message = "";
        //var fileupload = uploadFiles();

        if (type == 1) {
            ReceiverId = $("#dpUser").val().join(",");
            message = $("#txtMessage").val();
        }
        else if (type == 2) {
            message = $("#txtMsg").val();
        }

        if (ReceiverId == "" && (message == "" || GFileName == "")) {
            //alert("Receiver and Message is required.")
            return;
        }
        //const formData = new FormData();
        //formData.append("SenderId", SenderId);
        //formData.append("ReceiverId", ReceiverId);
        //formData.append("Message", message);
        //formData.append("MsgType", type);
        //formData.append("file", fileInput[0]);
        connection.invoke("SendMessage", formData);
        if (fileInput != null) {
            $(".overlayLoader").hide();
            $.ajax({
                url: '@Url.Action("UploadFile", "Chat")',
                type: 'POST',
                data: formData,//{ SingleFile: fileInput.files[0] },
                cache: false,
                processData: false,
                contentType: false
            }).done(function (response) {
                if (response != null) {
                    console.log(response.filename);
                    GFileName = response.filename;
                    //$(".chatLeftBoxBody").html("");
                    //$(".chatLeftBoxBody").html(response);
                    //$(".userList").removeClass("active");
                    //$("#li" + ReceiverId).addClass("active");
                }
            });
        }
        else {
            var FileName = GFileName;
            //connection.invoke("SendMessage", SenderId, ReceiverId, message, type, FileName);
            connection.invoke("SendMessage", formData);
        }

        if (type == 1) { $("#txtMessage").val(""); }
        else if (type == 2) { $("#txtMsg").val(""); }
    }

    connection.start().then(function () {
        connection.invoke("OnConnectedAsync", SenderId);
    });

    connection.on("ReceiveMessage", function (ReceiverId, message, MsgType, FileName, extention) {

        if (MsgType == 1) {
            window.location.href = "@Url.Action("Index", "Chat")";
        }
        else {
            var FilePath = "../ReadWriteData/CHAT_FILES/";
            if (FileName != "" && FileName != null) { FilePath = FilePath + FileName }
            var element = "";


            if (Cnt == 0) {
                element += '<li><div class="messageDate"><span>' + "@DateTime.Now.ToString("dd MMMM yyyy")" + '</span></div></li>'
                $(".chatBodyText").append(element);
                Cnt = Cnt + 1;
            }

            //Sender Side
            if (SenderId != ReceiverId) {
                if (FileName != "" && FileName != null) {
                    if (extention == ".jpg" || extention == ".jpeg" || extention == ".png") {
                        //element += '<a><li class="sendTextHolder" > <div class="sendText" ><img id="imgC" style="width:100px;" class="attachment-img" src="' + FilePath + '" alt="Attachment Image"></div></li></a>'
                        element += '<li class="sendTextHolder" > <div class="sendText" >' +
                            '<div class="box-body">' +
                            '<div class="attachment-block clearfix">' +
                            '<a><img id="imgC" style="width:100px;" class="attachment-img" src="' + FilePath + '" alt="Attachment Image"></a>' +
                            '<div class="attachment-pushed"> ' +
                            '<h4 class="attachment-heading"><i class="fa fa-image">  ' + FileName + ' </i></h4>' +
                            '</div>' +
                            '</div>' +
                            '<a id="btnDownload" href="' + FilePath + '" class="btn btn-default btn-xs" download="' + FileName + '"><i class="fa fa fa-download"></i></a>' +
                            //'<button type="button" id="ShowModelImg"  value="' + FilePath + '"  class="btn btn-default btn-xs"><i class="fa fa-camera"></i></button>' +
                            '</div>' +
                            '</div></li>';
                    }
                }
                if (message != "" && message != null) {
                    element += '<li class="sendTextHolder" > <div class="sendText" >' + message + '<span class="timeStamp">' + "@DateTime.Now.ToString("hh:mm tt")" + '</span></div></li>';
                }
                $(".chatBodyText").append(element);
                $('.chatBoxBody').scrollTop($('.chatBoxBody').height());
                $("#txtMsg").focus();
            }

            //Receiver Side
            if (SenderId == ReceiverId) {
                if (FileName != "" && FileName != null) {
                    if (extention == ".jpg" || extention == ".jpeg" || extention == ".png") {
                        //element += '<a><li class="reciveTextHolder" > <div class="recieveText" ><img id="imgC" style="width:100px;" class="attachment-img" src="' + FilePath + '" alt="Attachment Image"></div></li></a>'
                        element += '<li class="reciveTextHolder" > <div class="recieveText" >' +
                            '<div class="box-body">' +
                            '<div class="attachment-block clearfix">' +
                            '<a><img id="imgC" style="width:100px;" class="attachment-img" src="' + FilePath + '" alt="Attachment Image"></a>' +
                            '<div class="attachment-pushed"> ' +
                            '<h4 class="attachment-heading"><i class="fa fa-image">  ' + FileName + ' </i></h4>' +
                            '</div>' +
                            '</div>' +
                            '<a id="btnDownload" href="' + FilePath + '" class="btn btn-default btn-xs" download="' + FileName + '"><i class="fa fa fa-download"></i></a>' +
                            //'<button type="button" id="ShowModelImg"  value="' + FilePath + '"  class="btn btn-default btn-xs"><i class="fa fa-camera"></i></button>' +
                            '</div>' +
                            '</div></li>';
                    }
                }
                if (message != "" && message != null) {
                    element += '<li class="reciveTextHolder" > <div class="recieveText" >' + message + '<span class="timeStamp">' + "@DateTime.Now.ToString("hh:mm tt")" + '</span></div></li>';
                }
                $(".chatBodyText").append(element);
                $('.chatBoxBody').scrollTop($('.chatBoxBody').height());
                $("#txtMsg").focus();
            }
        }
    });

    $('#txtMessage').keypress(function (e) {
        if (e.keyCode == 13) {  // detect the enter key
            SendMessage(1);
        }
    });

    function uploadFiles() {
        const file = document.getElementById("fileupload").files[0];

        //// Read the file as an ArrayBuffer
        //const reader = new FileReader();
        //reader.onload = function (e) {
        //    const arrayBuffer = e.target.result;

        //    // Convert the ArrayBuffer to a byte array
        //    byteArray = new Uint8Array(arrayBuffer);
        //    //return byteArray;
        //}
        //reader.readAsArrayBuffer(file);

        var reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onloadend = function (evt) {
            if (evt.target.readyState == FileReader.DONE) {
                var arrayBuffer = evt.target.result,
                    array = new Uint8Array(arrayBuffer);
                for (var i = 0; i < array.length; i++) {
                    byteArray.push(array[i]);
                }
            }
        }
    }

    function uploadFile3() {
        var files = document.getElementById("fileupload").files[0];
        var reader = new FileReader();
        reader.onload = processFile(files);
        reader.readAsArrayBuffer(files);
    }

    function processFile(theFile) {
        return function (e) {
            var theBytes = e.target.result; //.split('base64,')[1]; // use with uploadFile2
            byteArray.push(theBytes);
            //document.getElementById('divFile').innerText = '';
            //for (var i = 0; i < byteArray.length; i++) {
            //    byteArray += byteArray[i];
            //}
            console.log(byteArray);
        }
    }

</script>