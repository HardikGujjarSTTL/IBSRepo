@model IBS.Models.ProjectModel

@{
    ViewData["Title"] = "Project Details";
}

<div class="list-inner">
    <div class="tast-list">
        <h2>Project Master Details</h2>
    </div>
    <div>
        <a asp-controller="ProjectDetails" asp-action="Index" class="formBtn viewall-btn">View List</a>
    </div>
</div>

<section id="tab-1">
    <div class="task-listinput">
        <form data-ajax="true" asp-antiforgery="true" asp-controller="ProjectDetails" asp-action="ProjectSave" data-ajax-method="post" data-ajax-complete="completed" id="frmProjectDetails">
            <input type="hidden" name="hdnUploadedDocumentList_tab-1" id="hdnUploadedDocumentList_tab-1" value="" />
            <input type="hidden" value="@Model.Proj_ID" name="Proj_ID" id="Proj_ID" />
            <input type="hidden" value="0" id="DetailID" />
            <div class="accordion-body">
                <div class="row my-0">
                    <div class="col-md-3 mb-2">
                        <label for="Reference">Project Name</label>
                        <input type="text" class="input" asp-for="ProjectName" />
                        <span asp-validation-for="ProjectName" class="text-danger"></span>
                    </div>
                    <div class="col-md-3 mb-2">
                        <partial name="_FileUploader" model="(IBS.Models.FileUploaderDTO)ViewBag.Details_Of_Sanctioned_File" />
                    </div>
                    <div class="col-md-3 mb-2">
                        <label for="Reference">Start Date</label>
                        <input type="text" class="input datepicker" asp-for="StartDate" maxlength="300" />
                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label for="Reference">Completion Date</label>
                        <input type="text" class="input datepicker" asp-for="CompletionDate" maxlength="300" />
                        <span asp-validation-for="CompletionDate" class="text-danger"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <h3 class="heading3"><span class="fa fa-plus"></span> Add Project Detail</h3>
                    </div>
                </div>
                <div class="row my-0">
                    <div class="col-md-3 mb-3">
                        <label for="Reference">Sanctioned strength</label>
                        @Html.DropDownListFor(model => model.SancStrength, new SelectList(IBS.Models.Common.SanctionedStrength(), "Value", "Text"), "--Select--")
                        <span class="text-danger" id="spnSancStrength"></span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="Reference">Department</label>
                        @Html.DropDownListFor(model => model.Disc, new SelectList(IBS.Models.Common.DiscDepartment(), "Value", "Text"), "--Select--")
                        <span class="text-danger" id="spnDisc"></span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="Reference">Number</label>
                        <input type="text" class="input" asp-for="Numbers" onkeypress="return isNumber(event)" maxlength="50" />
                        <span class="text-danger" id="spnNumbers"></span>
                    </div>
                    <div class="col-md-2 mb-3 btnAlign">
                        <button type="button" id="BtnAdd" class="formBtn"><span class="fa fa-plus"></span> Add</button>
                    </div>
                </div>
                <div class="row my-0">
                    <div class="col-md-12 mb-3">
                        <section class="table-section">
                            <div class="task-listinput">
                                <div class="dash-table">
                                    <table id="dtProject" class="table-responsive">
                                        <thead>
                                            <tr>
                                                <th>Sanctioned Strength</th>
                                                <th>Department</th>
                                                <th>Number</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <div class="savenext-btn">
                    <button type="button" class="save-btn active" onclick="BtnSave()">Save</button>
                </div>
            </div>
        </form>
    </div>
</section>
<div id="modal-delete-conf-valuation-detail" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation!</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <div class="savenext-btn">
                    <button type="button" class="reset-btn" data-bs-dismiss="modal">No</button>
                    <button type="button" class="save-btn active" id="btnDeletevaluationDetail" data-id="">Yes</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {

    <partial name="_DataTablesScriptsPartial" />
    <partial name="_ValidationScriptsPartial" />

    <script type="text/javascript">
        $(document).ready(function () {
            InitializeProjectData();
        });

        function BtnSave() {
            if ($("#frmProjectDetails").valid()) {
                if (!SaveSingleDocuments("tab-1")) return;
                $("#frmProjectDetails").submit();
            }
        }

        completed = function (response) {
            var res = response.responseJSON;
            ShowHideMsgNew(res.status, res.responseText);
            if (res.status) {
                window.location.href = '@Url.Action("Index", "ProjectDetails")';
            }
        };

        function validation() {
            var IsValid = true;
            if ($("#SancStrength").val() == "") {
                $("#spnSancStrength").html("Sanctioned strength is required.");
                IsValid = false;
            }
            if ($("#Disc").val() == "") {
                $("#spnDisc").html("Department is required.");
                IsValid = false;
            }
            if ($("#Numbers").val() == "") {
                $("#spnNumbers").html("Number is required.");
                IsValid = false;
            }
            return IsValid;
        }

        $("#BtnAdd").on("click", function () {
            if (!validation()) return;
            var formData = {
                Proj_ID: $("#Proj_ID").val(),
                DetailID: $("#DetailID").val(),
                Sanctionedstrength: $("#SancStrength").val(),
                SanctionedstrengthText: $("#SancStrength option:selected").text(),
                Department: $("#Disc").val(),
                DepartmentText: $("#Disc option:selected").text(),
                Nos: $("#Numbers").val(),
            }
            $.post("@Url.Action("SaveDetails", "ProjectDetails")", { model: formData }, function (response) {
                ShowHideMsgNew(response.status, response.responseText);
                if (response.status) {
                    InitializeProjectData();
                    clearManpowerDetail();
                }
            });
        });

        function clearManpowerDetail() {
            $("#DetailID").val("");
            $('#SancStrength').val("");
            $('#Disc').val("");
            $("#Numbers").val("");
        }

        function InitializeProjectData() {
            $("#dtProject").DataTable({
                stateSave: false,
                autoWidth: true,
                scrollX: true,
                scrollCollapse: true,
                processing: true,
                serverSide: true,
                destroy: true,
                paging: true,
                searching: true,
                ajax: {
                    url: "@Url.Action("LoadProjectDetailsTable")",
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: function (d) {
                        var AdditionalValues = {
                        };
                        d.AdditionalValues = AdditionalValues;
                        return JSON.stringify(d);
                    }
                },
                columns: [

                    { data: "SanctionedstrengthText" },
                    { data: "DepartmentText" },
                    { data: "Nos" },
                    {
                        data: null, orderable: false,
                        render: function (data, type, row) {
                            var id = data.DetailID;
                            var html = '<div align=\"center\" class=\"reportIcon\"> <a onclick="ProjectDetailEdit(' + id + '); return false; " href="javascript: void (\'0\');" class=\"edit\"><i class=\"fa fa-pencil\" title="Edit"></i></a>';
                            html += '<a class="delete" href="javascript:void(0);" data-id="' + id + '"><i class="fa fa-trash Permission_Delete" title="Delete" style="margin:10px;"></i></a>';
                            html += '</div>';
                            return html;
                        }
                    },
                ],
                "order": [[0, "asc"]]
            });
        }

        function ProjectDetailEdit(id) {
            $.ajax({
                url: '@Url.Action("EditProject", "ProjectDetails")?id=' + id,
                type: 'GET',
                cache: false,
                processData: false,
                contentType: false
            }).done(function (response) {
                if (response.status) {
                    $("#SancStrength").val(response.list.Sanctionedstrength);
                    $("#Disc").val(response.list.Department);
                    $("#Numbers").val(response.list.Nos);
                    $("#Proj_ID").val(response.list.Proj_ID);
                    $("#DetailID").val(response.list.DetailID);
                }
            });
        }

        $('#dtProject tbody').on('click', 'tr', function () {
            var rowData = $('#dtProject').DataTable().row($(this).closest('tr')).data();
            ProjectDetailEdit(rowData.In_ID);
        });

        $('#dtProject tbody').on('click', '.delete', function () {
            var id = $(this).data('id');
            Delete(id);
            return false;
        });

        function Delete(id) {
            $("#btnDeletevaluationDetail").attr("data-id", id);
            $("#modal-delete-conf-valuation-detail").modal("show");
        }

        $("#btnDeletevaluationDetail").click(function () {
            var ProjID = $("#Proj_ID").val();
            $.ajax({
                url: '@Url.Action("DeleteprojectDetail", "ProjectDetails")?DetailID=' + $(this).attr("data-id") + '&ProjID=' + ProjID,
                type: 'POST',
                cache: false,
                processData: false,
                contentType: false
            }).done(function (response) {
                ShowHideMsgNew(response.status, response.responseText);
                if (response.status) {
                    $("#btnDeletevaluationDetail").attr("data-id", "");
                    $("#modal-delete-conf-valuation-detail").modal('hide');
                    InitializeProjectData();
                }
            });
        });
    </script>
}